<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shilings to QAR Exchange</title>
    <!-- Open Graph Meta Tags for better social media previews -->
    <meta property="og:title" content="E.A Shilings to QAR Exchange">
    <meta property="og:description" content="KES / TZS / UGX exchange to QAR">
    
    <meta property="og:url" content="https://dunroystrading.github.io/dunroystrading.com">
    <meta property="og:type" content="website">

    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .hidden {
            display: none;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.open {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 400px;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal.open .modal-content {
            transform: scale(1);
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <!-- Main Container -->
    <div class="w-full max-w-md bg-white p-6 rounded-3xl shadow-2xl border border-gray-100">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">Currency Exchange</h1>
        <p class="text-center text-gray-500 mb-8">
            <span id="from-currency-symbol">KES</span> to <span id="to-currency-symbol">QAR</span>
        </p>

        <!-- Currency Selection -->
        <div class="mb-6">
            <label for="currency-select" class="block text-sm font-medium text-gray-700 mb-2">Select Currency to Convert</label>
            <select id="currency-select" class="block w-full rounded-xl border-gray-300 px-4 py-3 text-base focus:border-emerald-500 focus:ring-emerald-500 transition-colors duration-200" onchange="updateUI(); handleInput('from');">
                <option value="kes" selected>Kenyan Shilling (KES)</option>
                <option value="ugx">Ugandan Shilling (UGX)</option>
                <option value="tzs">Tanzanian Shilling (TZS)</option>
            </select>
        </div>
        
        <!-- Dynamic Exchange Rate & Rate Catalog -->
        <div id="dynamic-rate-section">
            <!-- Content will be injected here by JavaScript -->
        </div>

        <!-- Conversion Form -->
        <div class="space-y-6">
            <!-- You Give -->
            <div>
                <label for="from-amount" class="block text-sm font-medium text-gray-700 mb-2" id="from-label">You Give (KES)</label>
                <div class="relative rounded-xl shadow-sm">
                    <input type="number" id="from-amount" placeholder="Enter amount" class="block w-full rounded-xl border-gray-300 px-4 py-3 text-base focus:border-blue-500 focus:ring-blue-500 transition-colors duration-200" oninput="handleInput('from')">
                </div>
            </div>
            <!-- You Get -->
            <div>
                <label for="to-amount" class="block text-sm font-medium text-gray-700 mb-2" id="to-label">You Get (QAR, before fees)</label>
                <div class="relative rounded-xl shadow-sm">
                    <input type="number" id="to-amount" placeholder="Amount in QAR" class="block w-full rounded-xl border-gray-300 px-4 py-3 text-base focus:border-blue-500 focus:ring-blue-500 transition-colors duration-200" oninput="handleInput('to')">
                </div>
            </div>
        </div>
        
        <!-- Minimum Amount Error Message -->
        <div id="amount-warning" class="hidden mt-4 p-3 bg-red-50 border border-red-200 rounded-xl text-sm text-red-700 font-medium text-center">
            Minimum transaction amount is 100 QAR. Please increase the amount.
        </div>
        <!-- High Amount Warning -->
        <div id="high-amount-warning" class="hidden mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-xl text-sm text-yellow-700 font-medium text-center">
            For transactions over 10,000 QAR, please contact us for the rate and fee.
        </div>
        <!-- Summary of Charges -->
        <div class="mt-6 p-4 rounded-xl bg-gray-50 border border-gray-200">
            <div class="flex justify-between items-center mb-1">
                <span class="text-sm text-gray-600">Transaction Fee:</span>
                <span id="transaction-fee" class="text-sm font-medium text-gray-800">0.00 QAR</span>
            </div>
            <div class="flex justify-between items-center mb-1">
                <span class="text-sm text-gray-600">Delivery Fee:</span>
                <span id="delivery-fee" class="text-sm font-medium text-gray-800">0.00 QAR</span>
            </div>
            <hr class="my-2 border-gray-200">
            <div class="flex justify-between items-center">
                <span class="text-lg font-bold text-gray-700">Total Charges:</span>
                <span id="total-charges" class="text-lg font-bold text-gray-800">0.00 QAR</span>
            </div>
        </div>
        <!-- Transaction and Delivery Options -->
        <div class="mt-6 mb-6 space-y-4">
            <!-- Transaction Type -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Transaction Type</label>
                <div class="flex items-center space-x-4">
                    <label class="flex items-center cursor-pointer">
                        <input type="radio" name="transaction-type" value="pickup" checked class="form-radio h-5 w-5 text-emerald-600 focus:ring-emerald-500" onchange="toggleTransactionDetails(); handleInput('from');">
                        <span class="ml-2 text-gray-700">Pick Up</span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                        <input type="radio" name="transaction-type" value="delivery" class="form-radio h-5 w-5 text-emerald-600 focus:ring-emerald-500" onchange="toggleTransactionDetails(); handleInput('from');">
                        <span class="ml-2 text-gray-700">Delivery</span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                        <input type="radio" name="transaction-type" value="bank-transfer" class="form-radio h-5 w-5 text-emerald-600 focus:ring-emerald-500" onchange="toggleTransactionDetails(); handleInput('from');">
                        <span class="ml-2 text-gray-700">Bank/Wallet</span>
                    </label>
                </div>
            </div>
            <!-- Delivery Location Dropdown (Initially hidden) -->
            <div id="delivery-location-container" class="hidden">
                <label for="delivery-location" class="block text-sm font-medium text-gray-700 mb-2">Delivery Location</label>
                <select id="delivery-location" class="block w-full rounded-xl border-gray-300 px-4 py-3 text-base focus:border-blue-500 focus:ring-blue-500 transition-colors duration-200" onchange="handleInput('from')">
                    <option value="doha">Within Doha</option>
                    <option value="outskirts">Outskirts of Doha</option>
                    <option value="far-from-doha">Far from Doha (Fee Estimated)</option>
                </select>
            </div>
            <!-- Bank/Wallet Transfer Details (Initially hidden) -->
            <div id="bank-transfer-container" class="hidden space-y-4 p-4 rounded-xl bg-blue-50 border border-blue-200">
                <h4 class="font-bold text-blue-800">Transfer Details</h4>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Select Transfer Method</label>
                    <div class="flex items-center space-x-4">
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="transfer-method" value="bank" checked class="form-radio h-4 w-4 text-blue-600 focus:ring-blue-500" onchange="toggleTransferInputs();">
                            <span class="ml-2 text-gray-700 text-sm">Bank Transfer</span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="transfer-method" value="wallet" class="form-radio h-4 w-4 text-blue-600 focus:ring-blue-500" onchange="toggleTransferInputs();">
                            <span class="ml-2 text-gray-700 text-sm">Wallet Transfer</span>
                        </label>
                    </div>
                </div>

                <!-- Bank Details Inputs (Initially shown for this option) -->
                <div id="bank-details" class="">
                    <label for="qatar-banks" class="block text-sm font-medium text-gray-700 mb-2">Bank Name</label>
                    <select id="qatar-banks" class="block w-full rounded-xl border-gray-300 px-4 py-3 text-base focus:border-blue-500 focus:ring-blue-500 transition-colors duration-200">
                        <option value="">Select a Bank</option>
                        <option value="QNB">Qatar National Bank (QNB)</option>
                        <option value="CBQ">Commercial Bank of Qatar (CBQ)</option>
                        <option value="Doha Bank">Doha Bank</option>
                        <option value="QIIB">Qatar Islamic International Bank (QIIB)</option>
                        <option value="QIB">Qatar Islamic Bank (QIB)</option>
                        <option value="other">Other</option>
                    </select>
                    <label for="iban-number" class="block text-sm font-medium text-gray-700 mt-4 mb-2">IBAN Number</label>
                    <input type="text" id="iban-number" placeholder="Enter IBAN" class="block w-full rounded-xl border-gray-300 px-4 py-3 text-base focus:border-blue-500 focus:ring-blue-500 transition-colors duration-200">
                </div>
                
                <!-- Wallet Inputs (Initially hidden) -->
                <div id="wallet-details" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Wallet Service</label>
                    <div class="flex items-center space-x-4">
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="wallet-type" value="ooredoo" checked class="form-radio h-4 w-4 text-blue-600 focus:ring-blue-500">
                            <span class="ml-2 text-gray-700 text-sm">Ooredoo Money</span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="wallet-type" value="ipay" class="form-radio h-4 w-4 text-blue-600 focus:ring-blue-500">
                            <span class="ml-2 text-gray-700 text-sm">I Pay </span>
                        </label>
                    </div>
                    <label for="wallet-number" class="block text-sm font-medium text-gray-700 mt-4 mb-2">Wallet Number</label>
                    <input type="text" id="wallet-number" placeholder="Enter Wallet Number" class="block w-full rounded-xl border-gray-300 px-4 py-3 text-base focus:border-blue-500 focus:ring-blue-500 transition-colors duration-200">
                </div>
            </div>
        </div>
        <!-- Final Amount You Get -->
        <div class="mt-6 mb-8 text-center bg-emerald-50 text-emerald-800 py-4 px-6 rounded-2xl">
            <h2 class="text-xl font-bold mb-1">Total You Will Receive</h2>
            <span id="final-qar-amount" class="text-4xl font-extrabold">0.00</span> QAR
        </div>
        <!-- Button to Proceed -->
        <button id="proceed-button" class="w-full bg-emerald-500 hover:bg-emerald-600 transition-colors duration-200 text-white font-bold py-3 px-4 rounded-xl text-lg focus:outline-none focus:ring-4 focus:ring-emerald-500 focus:ring-opacity-50 flex items-center justify-center space-x-2">
            <span>Place Order</span>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
              <path d="M12 2C6.477 2 2 6.477 2 12c0 1.996.598 3.868 1.636 5.432l-1.353 4.95a1 1 0 00.41 1.097A.993.993 0 003 23c.097 0 .193-.016.287-.047l4.97-1.341c1.558.91 3.327 1.411 5.143 1.411 5.523 0 10-4.477 10-10S17.523 2 12 2zm4.5 12.336c-.198.396-.454.498-.795.53-.34.032-.716.038-1.12.006-.552-.045-1.144-.19-1.848-.528-1.632-.79-2.704-2.42-2.79-2.55-.084-.13-.655-.867-.655-1.656 0-.79.394-1.185.553-1.345.16-.16.34-.2.585-.2.246 0 .428.006.59.336.16.33.546 1.32.59 1.408.043.09.073.19.01.272-.06.082-.12.19-.17.25-.05.06-.11.13-.17.2-0 .06-.12.17-.06.27.06.1.2.2.33.24.13.04.28.05.41.05.13 0 .27-.01.41-.01.838-.112 1.583-.393 2.112-.662.613-.314.99-.488 1.25-.6.28-.12.59-.1.86.06.27.16.4.34.48.56.08.22.08.41.02.51.01.01-.06.06-.12.12-.06.06-.13.12-.2.18-.06.06-.12.12-.18.18-.06.06-.11.1-.17.16-.06.06-.11.11-.11.11z"/>
            </svg>
        </button>
    </div>
    <!-- Client Details Modal -->
    <div id="client-details-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-gray-800 mb-4 text-center">Your Details</h3>
            <p class="text-gray-600 mb-6 text-center text-sm">Please provide your details to proceed with the order.</p>
            <div class="space-y-4">
                <div>
                    <label for="full-name" class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                    <input type="text" id="full-name" placeholder="Enter your full name" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500">
                </div>
                <div>
                    <label for="mobile-number" class="block text-sm font-medium text-gray-700 mb-2">Mobile Number</label>
                    <div class="flex space-x-2">
                        <select id="country-code" class="w-1/3 px-2 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 text-sm">
                            <option value="+974">+974 (Qatar)</option>
                            <option value="+254">+254 (Kenya)</option>
                            <option value="+256">+256 (Uganda)</option>
                            <option value="+255">+255 (Tanzania)</option>
                            <option value="other">Other</option>
                        </select>
                        <input type="tel" id="mobile-number" placeholder="Enter mobile number" class="w-2/3 px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500">
                    </div>
                </div>
                <div>
                    <label for="email-address" class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                    <input type="email" id="email-address" placeholder="Enter your email" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500" required>
                </div>
            </div>
            <div id="details-warning" class="hidden mt-4 p-3 bg-red-50 border border-red-200 rounded-xl text-sm text-red-700 font-medium text-center">
                Please provide your full name, mobile number, and email address.
            </div>
            <div class="flex justify-center space-x-4 mt-8">
                <button id="details-cancel-button" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-xl transition-colors duration-200">
                    Cancel
                </button>
                <button id="details-continue-button" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 px-6 rounded-xl transition-colors duration-200">
                    Continue to Order
                </button>
            </div>
        </div>
    </div>
    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="modal">
        <div class="modal-content text-center">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Confirm Order</h3>
            <p class="text-gray-600 mb-6">Are you sure you want to place an order to exchange <b id="modal-from-amount"></b> for <b id="modal-to-amount"></b>?</p>
            <div class="flex justify-center space-x-4">
                <button id="cancel-button" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-xl transition-colors duration-200">
                    Cancel
                </button>
                <button id="confirm-button" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 px-6 rounded-xl transition-colors duration-200">
                    Confirm & Send to WhatsApp
                </button>
            </div>
        </div>
    </div>
    <script>
        // *** IMPORTANT: YOU MUST UPDATE THESE VARIABLES BEFORE USING THE SITE ***
        // 1. Your WhatsApp phone number in international format without the '+'
        const whatsappPhoneNumber = '97431309960';
        
        // 2. The currency rates and fees
        const currencies = {
            'kes': {
                name: 'Kenyan Shilling',
                symbol: 'KES',
                isTiered: true,
                rate: 35.60,
            },
            'ugx': {
                name: 'Ugandan Shilling',
                symbol: 'UGX',
                isTiered: true,
                rate: 990,
            },
            'tzs': {
                name: 'Tanzanian Shilling',
                symbol: 'TZS',
                isTiered: true,
                rate: 694,
            }
        };

        // 3. Static delivery fees in QAR
        const deliveryFees = {
            doha: 15.00,
            outskirts: 25.00,
            'far-from-doha': 0.00 // This fee is estimated upon request
        };
        // 4. Minimum transaction amount in QAR
        const minQAR = 100.00;

        document.addEventListener('DOMContentLoaded', () => {
            updateUI();
            handleInput('from');
            document.getElementById('proceed-button').addEventListener('click', showClientDetailsModal);
            document.getElementById('details-cancel-button').addEventListener('click', hideClientDetailsModal);
            document.getElementById('details-continue-button').addEventListener('click', validateAndShowConfirmation);
            document.getElementById('cancel-button').addEventListener('click', hideConfirmationModal);
            document.getElementById('confirm-button').addEventListener('click', proceedToWhatsApp);
            toggleTransactionDetails();
            toggleTransferInputs();
        });

        // Updates UI elements based on the selected currency
        function updateUI() {
            const selectedCurrency = document.getElementById('currency-select').value;
            const currencyData = currencies[selectedCurrency];

            // Update display symbols
            document.getElementById('from-currency-symbol').textContent = currencyData.symbol;
            document.getElementById('to-currency-symbol').textContent = 'QAR';
            
            // Update labels
            document.getElementById('from-label').textContent = `You Give (${currencyData.symbol})`;
            document.getElementById('to-label').textContent = `You Get`;
            
            const rateCatalog = document.getElementById('dynamic-rate-section');
            rateCatalog.innerHTML = '';
            
            if (currencyData.isTiered) {
                // Tiered Rate Catalog for KES, UGX, and TZS
                rateCatalog.innerHTML = `
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-2xl shadow-lg mb-6 border border-indigo-100">
                        <h3 class="text-lg font-bold text-indigo-800 mb-4">ðŸ’° ${currencyData.symbol} Exchange Rates & Fees</h3>
                        <div class="grid grid-cols-3 gap-2 text-sm text-gray-700 font-medium text-center">
                            <!-- Header Row -->
                            <div class="py-2 px-1 text-indigo-800 font-semibold border-b-2 border-indigo-200">QAR Range</div>
                            <div class="py-2 px-1 text-indigo-800 font-semibold border-b-2 border-indigo-200">Rate</div>
                            <div class="py-2 px-1 text-indigo-800 font-semibold border-b-2 border-indigo-200">Fee</div>
                            <!-- Tiers -->
                            <div class="py-2 px-1">100 - 2,000</div>
                            <div class="py-2 px-1">${currencyData.rate.toFixed(2)}</div>
                            <div class="py-2 px-1">20.00 QAR</div>
                            <div class="py-2 px-1">2,001 - 10,000</div>
                            <div class="py-2 px-1">${currencyData.rate.toFixed(2)}</div>
                            <div class="py-2 px-1">1.1% of QAR</div>
                            <div class="py-2 px-1">10,001+</div>
                            <div class="py-2 px-1">${currencyData.rate.toFixed(2)}</div>
                            <div class="py-2 px-1">1% of QAR</div>
                        </div>
                    </div>
                `;
            }
        }
        
        // Toggles the visibility of the transaction detail containers
        function toggleTransactionDetails() {
            const transactionType = document.querySelector('input[name="transaction-type"]:checked').value;
            const deliveryContainer = document.getElementById('delivery-location-container');
            const bankContainer = document.getElementById('bank-transfer-container');
            
            if (transactionType === 'delivery') {
                deliveryContainer.classList.remove('hidden');
                bankContainer.classList.add('hidden');
            } else if (transactionType === 'bank-transfer') {
                deliveryContainer.classList.add('hidden');
                bankContainer.classList.remove('hidden');
            } else {
                deliveryContainer.classList.add('hidden');
                bankContainer.classList.add('hidden');
            }
        }

        // Toggles between bank and wallet inputs
        function toggleTransferInputs() {
            const transferMethod = document.querySelector('input[name="transfer-method"]:checked').value;
            const bankDetails = document.getElementById('bank-details');
            const walletDetails = document.getElementById('wallet-details');

            if (transferMethod === 'bank') {
                bankDetails.classList.remove('hidden');
                walletDetails.classList.add('hidden');
            } else {
                bankDetails.classList.add('hidden');
                walletDetails.classList.remove('hidden');
            }
        }
        
        // Function to determine the correct transaction fee based on QAR amount
        function getFee(qarAmount, selectedCurrency) {
            let fee;
            const currencyData = currencies[selectedCurrency];

            if (currencyData.isTiered) {
                if (qarAmount >= 2001 && qarAmount <= 10000) {
                    fee = qarAmount * 0.011;
                } else if (qarAmount > 10000) {
                    fee = qarAmount * 0.01;
                } else {
                    fee = 20.00;
                }
            } else {
                // This else block is kept for future non-tiered currencies
                fee = 0;
            }
            return fee;
        }

        // Calculates the final QAR amount after all fees are deducted
        function calculateFinalQar(qarAmount) {
            const selectedCurrency = document.getElementById('currency-select').value;
            const transactionType = document.querySelector('input[name="transaction-type"]:checked').value;
            const deliveryLocation = document.getElementById('delivery-location').value;

            const transactionFee = getFee(qarAmount, selectedCurrency);
            const currentDeliveryFee = (transactionType === 'delivery' ? deliveryFees[deliveryLocation] : 0.00);
            
            return qarAmount - transactionFee - currentDeliveryFee;
        }

        // Handles input from either the "from" or "to" field
        function handleInput(source) {
            const selectedCurrency = document.getElementById('currency-select').value;
            const currencyData = currencies[selectedCurrency];

            let fromAmount, toAmount, finalQar;

            if (source === 'from') {
                fromAmount = parseFloat(document.getElementById('from-amount').value);
                if (isNaN(fromAmount) || fromAmount <= 0) {
                    clearOutputs();
                    return;
                }
                
                toAmount = fromAmount / currencyData.rate;
                finalQar = calculateFinalQar(toAmount);
                
                document.getElementById('to-amount').value = toAmount.toFixed(2);

            } else if (source === 'to') {
                toAmount = parseFloat(document.getElementById('to-amount').value);
                if (isNaN(toAmount) || toAmount <= 0) {
                    clearOutputs();
                    return;
                }
                
                fromAmount = toAmount * currencyData.rate;
                finalQar = calculateFinalQar(toAmount);
                
                document.getElementById('from-amount').value = fromAmount.toFixed(2);
            }
            
            // Re-calculate the transaction fee based on the raw QAR amount for display
            const displayedToAmount = parseFloat(document.getElementById('to-amount').value);
            const transactionFee = getFee(displayedToAmount, selectedCurrency);
            const transactionType = document.querySelector('input[name="transaction-type"]:checked').value;
            const deliveryLocation = document.getElementById('delivery-location').value;
            const currentDeliveryFee = (transactionType === 'delivery' ? deliveryFees[deliveryLocation] : 0.00);

            updateDisplay(finalQar, transactionFee, currentDeliveryFee, selectedCurrency);
        }
        
        // Helper function to update all display elements
        function updateDisplay(finalQar, transactionFee, currentDeliveryFee, selectedCurrency) {
            const currencyData = currencies[selectedCurrency];
            
            document.getElementById('transaction-fee').textContent = transactionFee.toFixed(2) + ' QAR';
            document.getElementById('delivery-fee').textContent = currentDeliveryFee.toFixed(2) + ' QAR';
            const totalCharges = transactionFee + currentDeliveryFee;
            document.getElementById('total-charges').textContent = totalCharges.toFixed(2) + ' QAR';
            
            document.getElementById('final-qar-amount').textContent = Math.max(0, finalQar).toFixed(2);
            
            // Check if the amount is below the minimum and disable the button
            const proceedButton = document.getElementById('proceed-button');
            const amountWarning = document.getElementById('amount-warning');
            const highAmountWarning = document.getElementById('high-amount-warning');
            const qarAmount = parseFloat(document.getElementById('to-amount').value);

            if (qarAmount > 10000) {
                highAmountWarning.classList.remove('hidden');
            } else {
                highAmountWarning.classList.add('hidden');
            }

            if (qarAmount > 0 && qarAmount < minQAR) {
                proceedButton.disabled = true;
                proceedButton.classList.add('opacity-50', 'cursor-not-allowed');
                amountWarning.classList.remove('hidden');
            } else if (qarAmount >= minQAR) {
                proceedButton.disabled = false;
                proceedButton.classList.remove('opacity-50', 'cursor-not-allowed');
                amountWarning.classList.add('hidden');
            }
        }
        
        // Helper function to clear all fields when input is invalid
        function clearOutputs() {
            document.getElementById('to-amount').value = '';
            document.getElementById('from-amount').value = '';
            document.getElementById('transaction-fee').textContent = '0.00 QAR';
            document.getElementById('delivery-fee').textContent = '0.00 QAR';
            document.getElementById('total-charges').textContent = '0.00 QAR';
            document.getElementById('final-qar-amount').textContent = '0.00';
            
            document.getElementById('proceed-button').disabled = true;
            document.getElementById('proceed-button').classList.add('opacity-50', 'cursor-not-allowed');
            document.getElementById('amount-warning').classList.add('hidden');
            document.getElementById('high-amount-warning').classList.add('hidden');
        }

        // --- New Modal Logic for Client Details ---
        function showClientDetailsModal() {
            document.getElementById('client-details-modal').classList.add('open');
        }

        function hideClientDetailsModal() {
            document.getElementById('client-details-modal').classList.remove('open');
            document.getElementById('details-warning').classList.add('hidden');
        }

        function validateAndShowConfirmation() {
            const fullName = document.getElementById('full-name').value.trim();
            const mobileNumber = document.getElementById('mobile-number').value.trim();
            const emailAddress = document.getElementById('email-address').value.trim();

            if (!fullName || !mobileNumber || !emailAddress) {
                document.getElementById('details-warning').classList.remove('hidden');
                return;
            }
            
            // Hide details modal and show confirmation modal
            hideClientDetailsModal();
            showConfirmationModal();
        }

        // Show the confirmation modal with transaction details
        function showConfirmationModal() {
            const selectedCurrency = document.getElementById('currency-select').value;
            const currencyData = currencies[selectedCurrency];
            const fromAmount = parseFloat(document.getElementById('from-amount').value).toFixed(2);
            const toAmount = parseFloat(document.getElementById('to-amount').value);
            const finalQar = calculateFinalQar(toAmount);

            document.getElementById('modal-from-amount').textContent = `${fromAmount} ${currencyData.symbol}`;
            document.getElementById('modal-to-amount').textContent = `${finalQar.toFixed(2)} QAR`;
            
            document.getElementById('confirmation-modal').classList.add('open');
        }

        // Hide the confirmation modal
        function hideConfirmationModal() {
            document.getElementById('confirmation-modal').classList.remove('open');
        }
        
        // Function to handle the WhatsApp message
        function proceedToWhatsApp() {
            const selectedCurrency = document.getElementById('currency-select').value;
            const currencyData = currencies[selectedCurrency];

            // Get client details
            const fullName = document.getElementById('full-name').value.trim();
            const countryCode = document.getElementById('country-code').value.trim();
            const mobileNumber = document.getElementById('mobile-number').value.trim();
            const fullMobileNumber = countryCode === 'other' ? mobileNumber : countryCode + mobileNumber;
            const emailAddress = document.getElementById('email-address').value.trim();
            
            const fromAmount = parseFloat(document.getElementById('from-amount').value).toFixed(2);
            const toAmount = parseFloat(document.getElementById('to-amount').value);
            const transactionType = document.querySelector('input[name="transaction-type"]:checked').value;
            
            const transactionFee = getFee(toAmount, selectedCurrency);
            const deliveryLocation = document.getElementById('delivery-location').value;
            const currentDeliveryFee = (transactionType === 'delivery' ? deliveryFees[deliveryLocation] : 0.00);
            const totalCharges = transactionFee + currentDeliveryFee;
            const finalQar = toAmount - totalCharges;
            let currentRate = currencyData.rate;
            let transactionFeeText;
            
            if (toAmount >= 2001 && toAmount <= 10000) {
                transactionFeeText = `1.1% of QAR amount`;
            } else if (toAmount > 10000) {
                transactionFeeText = `1% of QAR amount`;
            } else {
                transactionFeeText = '20.00 QAR';
            }
            
            let deliveryLocationText = 'N/A';
            let deliveryFeeText = '0.00 QAR';
            let extraDetails = '';
            const transactionId = Math.random().toString(36).substring(2, 8).toUpperCase();
            
            // Handle delivery details
            if (transactionType === 'delivery') {
                const deliveryLocation = document.getElementById('delivery-location').value;
                const currentDeliveryFee = deliveryFees[deliveryLocation];
                switch(deliveryLocation) {
                    case 'doha':
                        deliveryLocationText = 'Within Doha';
                        deliveryFeeText = `${currentDeliveryFee.toFixed(2)} QAR`;
                        break;
                    case 'outskirts':
                        deliveryLocationText = 'Outskirts of Doha';
                        deliveryFeeText = `${currentDeliveryFee.toFixed(2)} QAR`;
                        break;
                    case 'far-from-doha':
                        deliveryLocationText = 'Far from Doha';
                        deliveryFeeText = 'Estimated upon request';
                        break;
                }
            } else if (transactionType === 'bank-transfer') {
                const transferMethod = document.querySelector('input[name="transfer-method"]:checked').value;
                if (transferMethod === 'bank') {
                    const bankName = document.getElementById('qatar-banks').value;
                    const ibanNumber = document.getElementById('iban-number').value;
                    extraDetails = `\nBank: ${bankName || 'Not selected'}\nIBAN: ${ibanNumber || 'Not provided'}`;
                } else if (transferMethod === 'wallet') {
                    const walletType = document.querySelector('input[name="wallet-type"]:checked').value;
                    const walletNumber = document.getElementById('wallet-number').value;
                    extraDetails = `\nWallet Service: ${walletType.charAt(0).toUpperCase() + walletType.slice(1)}\nWallet Number: ${walletNumber || 'Not provided'}`;
                }
            }
            
            const message = `*New Currency Exchange Request*\n\n` +
                                `*Client Details*\n` +
                                `Full Name: ${fullName}\n` +
                                `Mobile: ${fullMobileNumber}\n` +
                                `Email: ${emailAddress}\n\n` +
                                `*Order Details*\n` +
                                `You Give (${currencyData.symbol}): ${fromAmount}\n` +
                                `You Get (QAR, final): ${finalQar.toFixed(2)}\n\n` +
                                `Transaction Fee: ${transactionFeeText}\n` +
                                `Delivery Fee: ${deliveryFeeText}\n` +
                                `*Total Charges: ${totalCharges.toFixed(2)} QAR*\n\n` +
                                `*Final QAR to Receive: ${finalQar.toFixed(2)}*\n` +
                                `Exchange Rate: 1 QAR = ${currentRate.toFixed(2)} ${currencyData.symbol}\n\n` +
                                `Transaction Type: ${transactionType.charAt(0).toUpperCase() + transactionType.slice(1)}\n` +
                                `Delivery Location: ${deliveryLocationText}` +
                                extraDetails +
                                `\n\nTransaction ID: #${transactionId}\n\n` +
                                `Please confirm availability to proceed.`;
            
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/${whatsappPhoneNumber}?text=${encodedMessage}`;
            window.open(whatsappUrl, '_blank');
        }
    </script>
</body>
</html>
